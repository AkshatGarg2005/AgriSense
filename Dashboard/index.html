<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSense Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #81c784;
            --accent-color: #c8e6c9;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .dashboard-header {
            margin-bottom: 30px;
        }
        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            height: 100%;
            border: none;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            border-bottom: none;
            font-weight: 600;
        }
        .temp-card .card-header {
            background-color: rgba(46, 125, 50, 0.2);
            color: var(--primary-color);
        }
        .humidity-card .card-header {
            background-color: rgba(3, 169, 244, 0.2);
            color: #0288d1;
        }
        .moisture-card .card-header {
            background-color: rgba(121, 85, 72, 0.2);
            color: #5d4037;
        }
        .current-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .temp-card .current-value {
            color: var(--primary-color);
        }
        .humidity-card .current-value {
            color: #0288d1;
        }
        .moisture-card .current-value {
            color: #5d4037;
        }
        .unit {
            font-size: 1.2rem;
            font-weight: normal;
            opacity: 0.7;
        }
        .status-indicator {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
        }
        .status-connected {
            background-color: rgba(46, 125, 50, 0.2);
            color: var(--primary-color);
        }
        .status-disconnected, .status-error {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--danger-color);
        }
        .status-connecting {
            background-color: rgba(255, 152, 0, 0.2);
            color: var(--warning-color);
        }
        .status-indicator i {
            margin-right: 5px;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .data-history {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        @media (max-width: 768px) {
            .dashboard-card {
                margin-bottom: 20px;
            }
            .current-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="dashboard-header text-center">
        <h1 class="display-4 fw-bold text-success">
            <i class="fas fa-leaf me-2"></i>AgriSense Dashboard
        </h1>
        <p class="lead text-muted">Real-time monitoring of your agricultural environment</p>
        <div class="mt-3 mb-4">
        <span id="status" class="status-indicator status-connecting">
          <i class="fas fa-spinner fa-spin"></i> Connecting...
        </span>
        </div>
    </div>

    <div class="row">
        <!-- Temperature Card -->
        <div class="col-md-4 mb-4">
            <div class="card dashboard-card temp-card">
                <div class="card-header bg-light">
                    <i class="fas fa-temperature-high me-2"></i>Temperature
                </div>
                <div class="card-body text-center">
                    <div class="current-value" id="temperature">--<span class="unit">°C</span></div>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    <div class="data-history">
                        Last 10 minutes of readings
                    </div>
                </div>
            </div>
        </div>

        <!-- Humidity Card -->
        <div class="col-md-4 mb-4">
            <div class="card dashboard-card humidity-card">
                <div class="card-header bg-light">
                    <i class="fas fa-tint me-2"></i>Humidity
                </div>
                <div class="card-body text-center">
                    <div class="current-value" id="humidity">--<span class="unit">%</span></div>
                    <div class="chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                    <div class="data-history">
                        Last 10 minutes of readings
                    </div>
                </div>
            </div>
        </div>

        <!-- Soil Moisture Card -->
        <div class="col-md-4 mb-4">
            <div class="card dashboard-card moisture-card">
                <div class="card-header bg-light">
                    <i class="fas fa-water me-2"></i>Soil Moisture
                </div>
                <div class="card-body text-center">
                    <div class="current-value" id="soilMoisture">--</div>
                    <div class="chart-container">
                        <canvas id="soilMoistureChart"></canvas>
                    </div>
                    <div class="data-history">
                        Last 10 minutes of readings
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card dashboard-card">
                <div class="card-header bg-light">
                    <i class="fas fa-info-circle me-2"></i>System Information
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Last Updated:</strong> <span id="lastUpdated">--</span></p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Connection:</strong> <span id="connectionInfo">ws://192.168.76.140:5000</span></p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Uptime:</strong> <span id="uptime">--</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Initialize time tracking for uptime and last update timestamp
    const startTime = new Date();
    let lastUpdateTime = null;

    // Maximum data points for charts
    const maxDataPoints = 20;
    const temperatureData = Array(maxDataPoints).fill(null);
    const humidityData = Array(maxDataPoints).fill(null);
    const soilMoistureData = Array(maxDataPoints).fill(null);
    const timeLabels = Array(maxDataPoints).fill('');

    // Format time string
    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // Update uptime display
    function updateUptime() {
        const now = new Date();
        const diff = now - startTime;

        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        document.getElementById('uptime').innerText =
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Initialize charts using Chart.js
    const temperatureChart = new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'Temperature (°C)',
                data: temperatureData,
                borderColor: '#2e7d32',
                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#2e7d32',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    grid: { display: false },
                    ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 5 }
                }
            },
            plugins: { legend: { display: false } },
            animation: { duration: 500 }
        }
    });

    const humidityChart = new Chart(document.getElementById('humidityChart'), {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'Humidity (%)',
                data: humidityData,
                borderColor: '#0288d1',
                backgroundColor: 'rgba(3, 169, 244, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#0288d1',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    grid: { display: false },
                    ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 5 }
                }
            },
            plugins: { legend: { display: false } },
            animation: { duration: 500 }
        }
    });

    const soilMoistureChart = new Chart(document.getElementById('soilMoistureChart'), {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'Soil Moisture',
                data: soilMoistureData,
                borderColor: '#5d4037',
                backgroundColor: 'rgba(121, 85, 72, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#5d4037',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    grid: { display: false },
                    ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 5 }
                }
            },
            plugins: { legend: { display: false } },
            animation: { duration: 500 }
        }
    });

    // Function to update the charts with new data
    function updateCharts(temperature, humidity, soilMoisture) {
        const now = new Date();
        const timeStr = formatTime(now);

        temperatureData.push(temperature);
        humidityData.push(humidity);
        soilMoistureData.push(soilMoisture);
        timeLabels.push(timeStr);

        if (temperatureData.length > maxDataPoints) {
            temperatureData.shift();
            humidityData.shift();
            soilMoistureData.shift();
            timeLabels.shift();
        }

        temperatureChart.data.labels = timeLabels;
        temperatureChart.data.datasets[0].data = temperatureData;
        temperatureChart.update();

        humidityChart.data.labels = timeLabels;
        humidityChart.data.datasets[0].data = humidityData;
        humidityChart.update();

        soilMoistureChart.data.labels = timeLabels;
        soilMoistureChart.data.datasets[0].data = soilMoistureData;
        soilMoistureChart.update();
    }

    // Connect to the WebSocket server
    const socket = new WebSocket("ws://192.168.76.140:5000");

    socket.onopen = function() {
        document.getElementById("status").className = "status-indicator status-connected";
        document.getElementById("status").innerHTML = '<i class="fas fa-check-circle"></i> Connected';
    };

    socket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);

            // Update current sensor values on the dashboard
            document.getElementById("temperature").innerHTML = data.temperature.toFixed(2) + '<span class="unit">°C</span>';
            document.getElementById("humidity").innerHTML = data.humidity.toFixed(2) + '<span class="unit">%</span>';
            document.getElementById("soilMoisture").innerHTML = data.soilMoisture;

            // Update last updated time
            lastUpdateTime = new Date();
            document.getElementById("lastUpdated").innerText = formatTime(lastUpdateTime);

            // Update charts with new data
            updateCharts(data.temperature, data.humidity, data.soilMoisture);
        } catch (error) {
            console.error("JSON Parse Error:", error);
        }
    };

    socket.onerror = function() {
        document.getElementById("status").className = "status-indicator status-error";
        document.getElementById("status").innerHTML = '<i class="fas fa-exclamation-triangle"></i> WebSocket Error';
    };

    socket.onclose = function() {
        document.getElementById("status").className = "status-indicator status-disconnected";
        document.getElementById("status").innerHTML = '<i class="fas fa-times-circle"></i> Disconnected';
    };

    // Update uptime every second
    setInterval(updateUptime, 1000);
</script>
</body>
</html>
